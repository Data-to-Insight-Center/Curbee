package org.seadva.registry.database.model.dao.vaRegistry.impl;

import org.apache.log4j.Logger;
import org.seadva.registry.database.common.DBConnectionPool;
import org.seadva.registry.database.common.ObjectPool;
import org.seadva.registry.database.model.dao.vaRegistry.BaseEntityDao;
import org.seadva.registry.database.model.dao.vaRegistry.CollectionDao;
import org.seadva.registry.database.model.dao.vaRegistry.PropertyDao;
import org.seadva.registry.database.model.dao.vaRegistry.StateDao;
import org.seadva.registry.database.model.obj.vaRegistry.*;
import org.springframework.stereotype.Repository;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;


/**
 * DAO for table: Collection.
 * @author autogenerated
 */
@Repository
public class CollectionDaoImpl implements CollectionDao {
    protected Connection getConnection() throws SQLException {
        return connectionPool.getEntry();
    }
    public CollectionDaoImpl(){
        connectionPool = DBConnectionPool.getInstance();
        baseEntityDao = new BaseEntityDaoImpl();
        stateDao = new StateDaoImpl();
        propertyDao = new PropertyDaoImpl();
    }

    BaseEntityDao baseEntityDao;
    StateDao stateDao;
    PropertyDao propertyDao;
    private static Logger log = Logger.getLogger(CollectionDaoImpl.class);


    protected ObjectPool<Connection> connectionPool = null;

    @Override
    public Collection getCollection(String entityId) {
        Collection collection = null;
        Connection connection = null;
        PreparedStatement statement = null;
        boolean isCollection = false;


        try {
            connection = getConnection();

            statement = connection.prepareStatement("Select * from collection where entity_id=?");
            statement.setString(1, entityId);
            ResultSet resultSet = statement.executeQuery();

            String name = null;
            int isObsolete = 0;
            State state = null;

            while (resultSet.next()) {
                name = resultSet.getString("name");
                isObsolete = resultSet.getInt("is_obsolete");
                state = stateDao.getStateById(resultSet.getString("state_id"));
                isCollection = true;
                break;
            }

            if(isCollection){
                BaseEntity entity = baseEntityDao.getBaseEntity(entityId);
                collection = new Collection(entity);
                collection.setName(name);
                collection.setIsObsolete(isObsolete);
                collection.setState(state);
            }

        } catch (SQLException sqle) {
            throw new RuntimeException(sqle);
        } finally {
            if (statement != null) {
                try {
                    statement.close();
                } catch (SQLException e) {
                  //  log.warn("Unable to close statement", e);
                }
                statement = null;
            }
            connectionPool.releaseEntry(connection);

        }
        return collection;
    }

    @Override
    public boolean insertCollection(Collection collection) {

        Connection connection = null;
        PreparedStatement statement = null;
        /**
         * This is to handle sub-collections which doesn't go under CO, PO or CuO
         * We identify all sub-collections as OO or 'OtherObject' type.
         */
        if (collection.getState() == null) {
            State s = new State();
            s.setId("state:4");
            s.setStateName("OO");
            collection.setState(s);
        }
        try {
            baseEntityDao.insertEntity(collection);
            connection = getConnection();
            statement = connection.prepareStatement("INSERT INTO collection (entity_id, state_id, is_obsolete, version_num, name) values(?,?,?,?,?) " +
                    "ON DUPLICATE KEY UPDATE " +
                    "state_id=?," +
                    "is_obsolete=?," +
                    "version_num=?," +
                    "name=?");
            statement.setString(1, collection.getId());
            statement.setString(2, collection.getState().getId());
            statement.setInt(3, collection.getIsObsolete());
            String versionNum = "1";
            if(collection.getVersionNum()!=null)
                versionNum = collection.getVersionNum();
            statement.setString(4, versionNum);
            statement.setString(5, collection.getName());
            statement.setString(6, collection.getState().getId());
            statement.setInt(7, collection.getIsObsolete());
            statement.setString(8, versionNum);
            statement.setString(9, collection.getName());
            statement.executeUpdate();
            statement.close();

            log.debug("Done resetting unfinished raw notifications");
        } catch (SQLException sqle) {
            throw new RuntimeException(sqle);
        } finally {
            if (statement != null) {
                try {
                    statement.close();
                } catch (SQLException e) {
                    log.warn("Unable to close statement", e);
                }
                statement = null;
            }
            connectionPool.releaseEntry(connection);

        }

        return true;

    }

    @Override
    public List<Collection> listCollections(String submitterId, String repository, String type){

        List<Collection> collectionsList = new ArrayList<Collection>();

        String queryStr = "Select * from collection C ";

        if(submitterId!=null)
            queryStr+=", relation R";
        if(repository!=null)
            queryStr+=", data_location D, repository P ";
        if(type!=null)
            queryStr+=", state S";

        queryStr+=" where ";


        if(type!=null)
            queryStr += " C.state_id=S.state_id AND S.state_type='"+type+"' ";


        if(submitterId!=null){
            if(type!=null)
                queryStr+=" AND ";
            queryStr += " R.cause_id=C.id AND R.relation_type_id='rl:3' AND R.effect_id='"+submitterId+"'"; //querying for submitter/publisher.
        }
        // Todo query from RelationType table instead of providing rl:2 as identifier

        if(repository!=null) {
            if(type!=null || submitterId!=null)
                queryStr+=" AND ";
            queryStr += "  C.entity_id = D.entity_id AND D.location_type_id = P.repository_id AND P.repository_name ='"+repository+"'";
        }

        Connection connection = null;
        PreparedStatement statement = null;

        try {
            connection = getConnection();

            statement = connection.prepareStatement(queryStr);
            ResultSet resultSet = statement.executeQuery();


            List<CollectionWrapper> finalCollectionWrappers = new ArrayList<CollectionWrapper>();

            while (resultSet.next()) {
                String entityId = resultSet.getString("entity_id");
                BaseEntity entity = new BaseEntityDaoImpl().getBaseEntity(entityId);
                Collection collection = new Collection(entity);
                collection.setName(resultSet.getString("name"));
                collection.setIsObsolete(resultSet.getInt("is_obsolete"));
                State state = stateDao.getStateById(resultSet.getString("state_id"));
                collection.setState(state);
                collectionsList.add(collection);
            }


        } catch (SQLException sqle) {
            throw new RuntimeException(sqle);
        } finally {
            if (statement != null) {
                try {
                    statement.close();
                } catch (SQLException e) {
                    //  log.warn("Unable to close statement", e);
                }
                statement = null;
            }
            connectionPool.releaseEntry(connection);

        }
        return collectionsList;
    }

    @Override
    public List<Collection> queryByProperty(String key, String value){

        List<Collection> collectionsList = new ArrayList<Collection>();

        String queryStr = "Select * from collection C, property P, metadata_type M ";

        queryStr+=" where C.entity_id=P.entity_id AND P.metadata_id=M.metadata_id AND M.metadata_element='"+key+"' AND P.valueStr='"+value+"'";

        Connection connection = null;
        PreparedStatement statement = null;

        try {
            connection = getConnection();

            statement = connection.prepareStatement(queryStr);
            ResultSet resultSet = statement.executeQuery();


            List<CollectionWrapper> finalCollectionWrappers = new ArrayList<CollectionWrapper>();

            while (resultSet.next()) {
                String entityId = resultSet.getString("entity_id");
                BaseEntity entity = new BaseEntityDaoImpl().getBaseEntity(entityId);
                Collection collection = new Collection(entity);
                collection.setName(resultSet.getString("name"));
                collection.setIsObsolete(resultSet.getInt("is_obsolete"));

                collectionsList.add(collection);
            }


        } catch (SQLException sqle) {
            throw new RuntimeException(sqle);
        } finally {
            if (statement != null) {
                try {
                    statement.close();
                } catch (SQLException e) {
                    //  log.warn("Unable to close statement", e);
                }
                statement = null;
            }
            connectionPool.releaseEntry(connection);

        }
        return collectionsList;
    }

    @Override
    public List<Property> queryByCollection(String collectionId, String metadataId){
        List<Property> propertyList = new ArrayList<Property>();

        String queryStr = "Select * from property P ";
        queryStr+=" where P.entity_id='"+collectionId+"' AND P.metadata_id='"+metadataId+"'";

        Connection connection = null;
        PreparedStatement statement = null;

        try {
            connection = getConnection();

            statement = connection.prepareStatement(queryStr);
            ResultSet resultSet = statement.executeQuery();


            List<CollectionWrapper> finalCollectionWrappers = new ArrayList<CollectionWrapper>();

            while (resultSet.next()) {
                String entityId = resultSet.getString("entity_id");
                String metadata_id = resultSet.getString("metadata_id");
                BaseEntity entity = new BaseEntityDaoImpl().getBaseEntity(entityId);
                MetadataType metadataType = new MetadataTypeDaoImpl().getMetadataTypeById(metadata_id);
                Property property = new Property();
                property.setEntity(entity);
                property.setId(resultSet.getLong("property_id"));
                property.setValuestr(resultSet.getString("valueStr"));
                property.setMetadata(metadataType);
                propertyList.add(property);
            }
        } catch (SQLException sqle) {
            throw new RuntimeException(sqle);
        } finally {
            if (statement != null) {
                try {
                    statement.close();
                } catch (SQLException e) {
                    //  log.warn("Unable to close statement", e);
                }
                statement = null;
            }
            connectionPool.releaseEntry(connection);

        }
        return propertyList;
    }

    @Override
    public boolean updateState(String collectionId, String state) {
        Connection connection = null;
        PreparedStatement statement = null;
        int rows;
        try {
            Property typeProperty = queryByCollection(collectionId, "md:14").get(0);
            typeProperty.setValuestr(stateDao.getStateById(state).getStateType());
            Set<Property> propertySet = new HashSet<Property>();
            propertySet.add(typeProperty);
            propertyDao.putProperties(collectionId, propertySet);
            connection = getConnection();
            statement = connection.prepareStatement("UPDATE collection SET state_id=? WHERE entity_id=?");
            statement.setString(1, state);
            statement.setString(2, collectionId);
            rows = statement.executeUpdate();
            statement.close();
            log.debug("Done resetting unfinished raw notifications");
        } catch (SQLException sqle) {
            throw new RuntimeException(sqle);
        } finally {
            if (statement != null) {
                try {
                    statement.close();
                } catch (SQLException e) {
                    log.warn("Unable to close statement", e);
                }
                statement = null;
            }
            connectionPool.releaseEntry(connection);

        }
        if(rows > 0)
            return true;
        else
            return false;
    }
}

